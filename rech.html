<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recherche PDF ‚Ä¢ Megane Learn</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>
  <style>
    .search-container { text-align:center; padding:70px 20px 40px; }
    #searchInput { width:92%; max-width:700px; padding:20px 30px; font-size:1.6rem; border:6px solid #0066FF; border-radius:50px; outline:none; box-shadow:0 12px 35px rgba(0,102,255,0.25); }
    #status { margin:25px 0; font-size:1.3rem; color:#0066FF; font-weight:bold; }
    #resultCount { margin:30px 0; font-size:1.5rem; color:#0066FF; font-weight:bold; }
    .results-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:30px; padding:20px; max-width:1400px; margin:0 auto; }
    .result-card { background:white; border:5px solid #0066FF; border-radius:24px; padding:30px; text-align:left; box-shadow:0 15px 45px rgba(0,102,255,0.15); transition:0.4s; position:relative; }
    .result-card:hover { transform:translateY(-15px); box-shadow:0 30px 70px rgba(0,102,255,0.3); }
    .score-badge { position:absolute; top:-12px; right:15px; background:#0066FF; color:white; padding:6px 14px; border-radius:20px; font-weight:bold; font-size:0.9rem; }
    .file-title { font-weight:bold; font-size:1.5rem; color:#0066FF; margin-bottom:12px; }
    .snippet { background:#f8fbff; padding:18px; border-radius:15px; margin:15px 0; line-height:1.7; font-size:1.1rem; }
    .highlight { background:#ff0; color:#000; font-weight:bold; padding:2px 6px; border-radius:4px; }
    .download-btn { background:#0066FF; color:white; padding:14px 40px; border-radius:50px; text-decoration:none; font-weight:bold; display:inline-block; margin-top:10px; }

    /* BOUTON HISTORIQUE T√âL√âCHARGEMENTS (haut gauche) */
    .history-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background: #0066FF;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      box-shadow: 0 10px 30px rgba(0,102,255,0.5);
      z-index: 9998;
      cursor: pointer;
      transition: 0.3s;
    }
    .history-btn:hover { transform: scale(1.1); }
    .history-btn.spin { animation: spin 1.5s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .notification-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      background: #ff0033;
      border-radius: 50%;
      border: 3px solid white;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

    .history-modal {
      position: fixed;
      top: 90px;
      left: 20px;
      width: 340px;
      max-height: 70vh;
      background: white;
      border: 5px solid #0066FF;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 9997;
      overflow: hidden;
      display: none;
    }
    .history-modal.show { display: block; animation: pop 0.4s; }
    @keyframes pop { from { opacity:0; transform:scale(0.8); } to { opacity:1; transform:scale(1); } }
    .history-header { background:#0066FF; color:white; padding:15px; text-align:center; font-weight:bold; font-size:1.3rem; }
    .history-list { padding:15px; max-height:60vh; overflow-y:auto; }
    .history-item { padding:12px; background:#f8fbff; margin:8px 0; border-radius:12px; color:#0066FF; font-weight:600; word-break:break-all; }
  </style>
</head>
<body>

  <!-- BOUTON HISTORIQUE T√âL√âCHARGEMENTS -->
  <div class="history-btn" id="historyBtn">‚¨á</div>
  <div class="history-modal" id="historyModal">
    <div class="history-header">PDF t√©l√©charg√©s r√©cemment</div>
    <div class="history-list" id="historyList">
      <div style="text-align:center;color:#888;padding:30px;">Aucun t√©l√©chargement</div>
    </div>
  </div>

  <div class="search-container">
    <h1 style="color:#0066FF;">üîç Recherche intelligente</h1>
    <input type="text" id="searchInput" placeholder="Ex : cours de math primitive, frein ABS, sch√©ma √©lectrique..." autofocus>
    <div id="status">Chargement des PDF depuis rechfiles/...</div>
    <div id="resultCount"></div>
  </div>

  <div class="results-grid" id="results"></div>

  <nav class="bottom-nav">
    <a href="index.html">ACCUEIL</a>
    <a href="propos.html">√Ä PROPOS</a>
    <a href="contact.html">CONTACT</a>
    <a href="confidentialite.html">CONFIDENTIALIT√â</a>
  </nav>

  <script type="module">
    // === CODE DE RECHERCHE INTELLIGENTE (identique √† avant) ===
    const RECH_FOLDER = "rechfiles";
    let allPDFs = [];

    async function loadPDFList() {
      try {
        const resp = await fetch(`https://api.github.com/repos/ivanipote/PDF-search/contents/${RECH_FOLDER}`);
        const files = await resp.json();
        allPDFs = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
        document.getElementById("status").textContent = `${allPDFs.length} PDF charg√©s ‚Äì tape plusieurs mots !`;
        showAllPDFs();
      } catch (e) {
        document.getElementById("status").textContent = "Erreur dossier rechfiles";
      }
    }

    function highlightText(text, terms) {
      let highlighted = text;
      terms.forEach(term => {
        const regex = new RegExp(`(${term})`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
      });
      return highlighted;
    }

    function calculateScore(pdfName, pdfText, terms) {
      let score = 0;
      const lowerName = pdfName.toLowerCase();
      const lowerText = pdfText.toLowerCase();
      terms.forEach(term => {
        if (lowerName.includes(term)) score += 3;
        if (lowerText.includes(term)) score += 1;
      });
      return score;
    }

    async function search(query) {
      const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1);
      if (terms.length === 0) {
        showAllPDFs();
        return;
      }

      let results = [];

      for (const pdf of allPDFs) {
        let snippet = "";
        let fullText = "";

        if (pdf.name.toLowerCase().includes(terms.join(' '))) {
          snippet = "Nom de fichier tr√®s pertinent";
        }

        try {
          const loadingTask = pdfjsLib.getDocument(`https://raw.githubusercontent.com/ivanipote/PDF-search/main/${RECH_FOLDER}/${pdf.name}`);
          const doc = await loadingTask.promise;
          for (let p = 1; p <= Math.min(doc.numPages, 10); p++) {
            const page = await doc.getPage(p);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(i => i.str).join(" ");
            fullText += pageText + " ";
            if (!snippet && pageText.toLowerCase().split(/\s+/).some(word => terms.includes(word))) {
              snippet = pageText.substring(0, 300) + "...";
            }
          }
        } catch (e) {}

        const score = calculateScore(pdf.name, fullText, terms);
        if (score > 0) {
          results.push({ pdf, score, snippet: snippet || "Trouv√© dans le nom", terms });
        }
      }

      results.sort((a, b) => b.score - a.score);
      showResults(results);
    }

    function showResults(results) {
      const grid = document.getElementById("results");
      grid.innerHTML = "";
      document.getElementById("resultCount").textContent = `${results.length} r√©sultat${results.length > 1 ? 's' : ''}`;

      results.forEach(item => {
        const rawUrl = `https://raw.githubusercontent.com/ivanipote/PDF-search/main/${RECH_FOLDER}/${item.pdf.name}`;
        const card = document.createElement("div");
        card.className = "result-card";
        card.innerHTML = `
          ${item.score > 0 ? `<div class="score-badge">Score ${item.score}</div>` : ''}
          <div class="file-title">üìÑ ${item.pdf.name}</div>
          <div class="snippet">${highlightText(item.snippet, item.terms)}</div>
          <a href="${rawUrl}" download class="download-btn">T√©l√©charger</a>
        `;
        grid.appendChild(card);
      });
    }

    function showAllPDFs() {
      const grid = document.getElementById("results");
      grid.innerHTML = "";
      allPDFs.forEach(pdf => {
        const rawUrl = `https://raw.githubusercontent.com/ivanipote/PDF-search/main/${RECH_FOLDER}/${pdf.name}`;
        const card = document.createElement("div");
        card.className = "result-card";
        card.innerHTML = `
          <div class="file-title">üìÑ ${pdf.name}</div>
          <a href="${rawUrl}" download class="download-btn">T√©l√©charger</a>
        `;
        grid.appendChild(card);
      });
      document.getElementById("resultCount").textContent = `${allPDFs.length} PDF disponibles`;
    }

    document.getElementById("searchInput").addEventListener("input", (e) => {
      const query = e.target.value.trim();
      if (query.length < 2) {
        showAllPDFs();
      } else {
        search(query);
      }
    });

    loadPDFList();
  </script>

  <!-- BOUTON HISTORIQUE + NOTIFICATION -->
  <script>
    const historyBtn = document.getElementById("historyBtn");
    const historyModal = document.getElementById("historyModal");
    const historyList = document.getElementById("historyList");

    historyBtn.onclick = () => historyModal.classList.toggle("show");

    document.querySelectorAll('a[download]').forEach(link => {
      link.addEventListener("click", () => {
        // Animation
        historyBtn.classList.add("spin");
        setTimeout(() => historyBtn.classList.remove("spin"), 3000);

        // Historique
        const fileName = link.getAttribute("href").split("/").pop();
        let downloads = JSON.parse(localStorage.getItem("meganeDownloads") || "[]");
        downloads = [fileName, ...downloads.filter(n => n !== fileName)].slice(0, 30);
        localStorage.setItem("meganeDownloads", JSON.stringify(downloads));
        updateHistory();

        // Point rouge
        if (!document.querySelector(".notification-dot")) {
          const dot = document.createElement("div");
          dot.className = "notification-dot";
          historyBtn.appendChild(dot);
        }

        // Beep sonore
        const beep = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=");
        beep.volume = 0.4;
        beep.play();
      });
    });

    function updateHistory() {
      let downloads = JSON.parse(localStorage.getItem("meganeDownloads") || "[]");
      if (downloads.length === 0) {
        historyList.innerHTML = '<div style="text-align:center;color:#888;padding:30px;">Aucun t√©l√©chargement</div>';
      } else {
        historyList.innerHTML = "";
        downloads.forEach(name => {
          const item = document.createElement("div");
          item.className = "history-item";
          item.textContent = name;
          historyList.appendChild(item);
        });
      }
    }

    updateHistory();
  </script>

  <script src="script.js"></script>
</body>
  </html>
